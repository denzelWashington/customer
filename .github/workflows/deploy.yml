name: CI/CD OpenShift
on:
  push:
    branches: [ "main" ] # Se déclenche dès que tu push sur la branche main

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout du code
        uses: actions/checkout@v4

      # Connexion à Docker Hub (ou autre registry)
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.REGISTRY_USER }}
          password: ${{ secrets.REGISTRY_PASSWORD }}

      # Build et Push de l'image
      - name: Build and Push Image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          # Remplace 'ton-pseudo' par ton vrai pseudo Docker Hub
          tags: ${{ secrets.REGISTRY_USER }}/customer-image:v1

  deploy-to-openshift:
    needs: build-and-push # Attend que l'image soit sur le cloud pour continuer
    runs-on: ubuntu-latest
    steps:
      # 1. Installer l'outil 'oc' (CLI OpenShift)
      - name: Install OpenShift CLI
        uses: redhat-actions/openshift-tools-installer@v1
        with:
         oc: "4" # Installe la version 4 du client
      # Connexion à ton cluster OpenShift
      - name: Authenticate with OpenShift
        uses: redhat-actions/oc-login@v1
        with:
          openshift_server_url: ${{ secrets.OPENSHIFT_SERVER_URL }}
          openshift_token: ${{ secrets.OPENSHIFT_TOKEN }}
          insecure_skip_tls_verify: true

      # Déploiement de l'image
      - name: Deploy Image
        run: |
          # 1. On se place dans ton projet
          oc project wassim-sboui-dev

          # 2. On essaie de créer l'app, mais on ne s'arrête pas si elle existe déjà (|| true)
          oc new-app --docker-image=docker.io/${{ secrets.REGISTRY_USER }}/customer-image:v1 --name=customer-app || true

          # 3. On met à jour l'image pour être sûr qu'il utilise la v1
          oc set image deployment/customer-app customer-app=docker.io/${{ secrets.REGISTRY_USER }}/customer-image:v1

          # 4. On redémarre pour appliquer les changements
          oc rollout restart deployment/customer-app
